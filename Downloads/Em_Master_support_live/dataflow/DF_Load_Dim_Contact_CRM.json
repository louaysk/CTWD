{
    "name": "DF_Load_Dim_Contact_CRM",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "EM_CRMContact",
                        "type": "DatasetReference"
                    },
                    "name": "ODSContactcrm"
                },
                {
                    "dataset": {
                        "referenceName": "Dev_Account_CRM",
                        "type": "DatasetReference"
                    },
                    "name": "AccountCRM"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "DIM_CONTACT_CRM",
                        "type": "DatasetReference"
                    },
                    "name": "sink1"
                }
            ],
            "transformations": [
                {
                    "name": "lookup1"
                },
                {
                    "name": "derivedColumn1"
                },
                {
                    "name": "alterRow1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          EmailAddress as string,",
                "          companyName as string,",
                "          FirstName as string,",
                "          LastName as string,",
                "          JobTitle as string,",
                "          DesignationLevel as long,",
                "          TelephoneNumber as string,",
                "          MobilePhone as string,",
                "          Fax as string,",
                "          RegionID as string,",
                "          ContactType as long,",
                "          AccountId as string,",
                "          contactid as string,",
                "          modifiedon as timestamp,",
                "          createdon as string,",
                "          dwtc_nationalityname as string,",
                "          ccs_jobfunction as long,",
                "          emailaddress2 as string,",
                "          address1_line1 as string,",
                "          address1_line2 as string,",
                "          dwtc_cityname as string,",
                "          statecode as long,",
                "          address1_postalcode as string,",
                "          dwtc_countryname as string,",
                "          createdby as string,",
                "          modifiedby as string,",
                "          statuscode as long,",
                "          Prefix as string,",
                "          ccs_designationlevel as long,",
                "          phone1 as string,",
                "          phone2 as string,",
                "          grid as string,",
                "          designationlevelValue as string,",
                "          contacttypeValue as string,",
                "          stateValue as string,",
                "          Status as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: 'select c.*, \\n\\n   CONVERT(NVARCHAR(16),hashbytes(\\'md5\\',concat(upper(replace([emailaddress],\\' \\',\\'\\')),COALESCE(soundex(replace(FirstName,\\' \\',\\'\\')),\\'NA\\')\\n+COALESCE(soundex(replace(LastName,\\' \\',\\'\\')),\\'NA\\')\\n+COALESCE(soundex(replace(CompanyName,\\' \\',\\'\\')),\\'NA\\'))),2) grid, \\n\\n\\nd.[value] as designationlevelValue , t.[value] as contacttypeValue,statecode.[value] as stateValue, StatusCode.[value] as [Status]\\n\\n\\n  FROM [ods].[EM_Contacts_CRM] c left join (select * from \\n  [ods].[EM_StringMap_CRM]  a \\n  where  a.[attributename] =\\'dwtc_designationlevel\\' and  a.[objecttypecode] =\\'contact\\') d\\n  on c.[DesignationLevel]=d.[attributevalue]  left join  (select * from \\n  [ods].[EM_StringMap_CRM]  a \\n  where  a.[attributename] = \\'ccs_contacttype\\' and  a.[objecttypecode] =\\'contact\\') t\\n  on c.[ContactType]=t.[attributevalue] left join  (select * from \\n  [ods].[EM_StringMap_CRM]  a \\n  where  a.[attributename] = \\'statecode\\' and  a.[objecttypecode] =\\'contact\\') statecode\\n  on c.[statecode]=statecode.[attributevalue] left join  (select * from \\n  [ods].[EM_StringMap_CRM]  a \\n  where  a.[attributename] = \\'statecode\\' and  a.[objecttypecode] =\\'contact\\') StatusCode\\n  on c.[StatusCode]=StatusCode.[attributevalue]',",
                "     format: 'query',",
                "     staged: true) ~> ODSContactcrm",
                "source(output(",
                "          Account_ID as integer,",
                "          CountryID as string,",
                "          CountryName as string,",
                "          SectorName as string,",
                "          Name as string,",
                "          IndustryName as string,",
                "          CompanyID as string,",
                "          SubIndustryID as string,",
                "          POBox as string,",
                "          address1_line1 as string,",
                "          address2_line2 as string,",
                "          statecode as long,",
                "          address1_postalcode as string,",
                "          Region as string,",
                "          emailaddress1 as string,",
                "          websiteurl as string,",
                "          telephone2 as string,",
                "          dwtc_billingtosameasaddress1 as boolean,",
                "          dwtc_billingcityname as string,",
                "          dwtc_billingpostcodezipcode as string,",
                "          dwtc_billingcountryname as string,",
                "          dwtc_companyannualrev as long,",
                "          telephone1 as string,",
                "          City as string,",
                "          PrimaryContactID as string,",
                "          BillToContactName as string,",
                "          Company_ID as integer,",
                "          Execution_Date as timestamp",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     format: 'table',",
                "     staged: true) ~> AccountCRM",
                "ODSContactcrm, AccountCRM lookup(AccountId == CompanyID,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup1",
                "lookup1 derive(Execution_Date = currentUTC(),",
                "          createdon = toTimestamp(createdon),",
                "          SoundexName = coalesce(soundex(replace(FirstName,' ','')),'NA')\r",
                "+coalesce(soundex(replace(LastName,' ','')),'NA')\r",
                " +coalesce(soundex(replace(companyName,' ','')),'NA')) ~> derivedColumn1",
                "derivedColumn1 alterRow(upsertIf(1==1)) ~> alterRow1",
                "alterRow1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          Contact_ID as integer,",
                "          Contact_Code as string,",
                "          Email as string,",
                "          CompanyName as string,",
                "          FirstName as string,",
                "          LastName as string,",
                "          JobTitle as string,",
                "          DesignationLevel as string,",
                "          Statecode as string,",
                "          DateModified as timestamp,",
                "          DateCreated as timestamp,",
                "          MobilePhone as string,",
                "          ContactType as string,",
                "          Contact_GR_ID as integer,",
                "          Company_ID as integer,",
                "          Execution_Date as timestamp,",
                "          Nationality as string,",
                "          Jobfunction as long,",
                "          Emailaddress2 as string,",
                "          Address1_line1 as string,",
                "          Address1_line2 as string,",
                "          Cityname as string,",
                "          Address1_postalcode as string,",
                "          Country as string,",
                "          Createdby as string,",
                "          Modifiedby as string,",
                "          GR_ID as string,",
                "          Status as string,",
                "          Prefix as string,",
                "          PhoneNumber1 as string,",
                "          PhoneNumber2 as string,",
                "          MobilePhone2 as string",
                "     ),",
                "     deletable:false,",
                "     insertable:true,",
                "     updateable:false,",
                "     upsertable:true,",
                "     keys:['Contact_Code'],",
                "     format: 'table',",
                "     staged: true,",
                "     allowCopyCommand: true,",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError',",
                "     mapColumn(",
                "          Contact_Code = contactid,",
                "          Email = EmailAddress,",
                "          CompanyName = companyName,",
                "          FirstName,",
                "          LastName,",
                "          JobTitle,",
                "          DesignationLevel = designationlevelValue,",
                "          Statecode = ODSContactcrm@statecode,",
                "          DateModified = modifiedon,",
                "          DateCreated = createdon,",
                "          MobilePhone,",
                "          ContactType = contacttypeValue,",
                "          Company_ID,",
                "          Execution_Date,",
                "          Nationality = dwtc_nationalityname,",
                "          Jobfunction = ccs_jobfunction,",
                "          Emailaddress2 = emailaddress2,",
                "          Address1_line1 = ODSContactcrm@address1_line1,",
                "          Address1_line2 = address1_line2,",
                "          Cityname = dwtc_cityname,",
                "          Address1_postalcode = ODSContactcrm@address1_postalcode,",
                "          Country = dwtc_countryname,",
                "          Email = EmailAddress,",
                "          Status,",
                "          Prefix,",
                "          MobilePhone2 = TelephoneNumber,",
                "          PhoneNumber1 = telephone1,",
                "          PhoneNumber2 = telephone2,",
                "          GR_ID = grid",
                "     )) ~> sink1"
            ]
        }
    }
}