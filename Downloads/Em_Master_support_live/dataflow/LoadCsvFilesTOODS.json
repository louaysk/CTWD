{
    "name": "LoadCsvFilesTOODS",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "CsvFilesVisitors",
                        "type": "DatasetReference"
                    },
                    "name": "source1"
                },
                {
                    "linkedService": {
                        "referenceName": "dwtc-bi-WorkspaceDefaultStorage",
                        "type": "LinkedServiceReference"
                    },
                    "name": "source3"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "ODS_Visitors",
                        "type": "DatasetReference"
                    },
                    "name": "sink1"
                }
            ],
            "transformations": [
                {
                    "name": "select1"
                },
                {
                    "name": "join1"
                },
                {
                    "name": "select2"
                },
                {
                    "name": "derivedColumn1"
                },
                {
                    "name": "derivedColumn2"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          Index as string,",
                "          EventName as string,",
                "          Year as string,",
                "          QID as string,",
                "          Answers as string,",
                "          UAID as string,",
                "          Questions as string,",
                "          Type as string,",
                "          {$$AGE} as string,",
                "          {$$Address_line_2} as string,",
                "          {$$Address_line_3} as string,",
                "          {$$Badge_Type} as string,",
                "          {$$City_of_Company} as string,",
                "          {$$Cluster_Name} as string,",
                "          {$$Company_Name} as string,",
                "          {$$Country} as string,",
                "          {$$DWTC_CRM_ID} as string,",
                "          {$$Data_Source} as string,",
                "          {$$Designation} as string,",
                "          {$$Designation_Level} as string,",
                "          {$$Email} as string,",
                "          {$$Event_Year} as string,",
                "          {$$Exhibitor_Name} as string,",
                "          {$$First_Name} as string,",
                "          {$$Job_Function} as string,",
                "          {$$Last_Name} as string,",
                "          {$$Mobile_Number} as string,",
                "          {$$Nationality} as string,",
                "          {$$PAY_Mode} as string,",
                "          {$$Phone_Number} as string,",
                "          {$$Postal_Code} as string,",
                "          {$$Prefix} as string,",
                "          {$$Reg_Date} as string,",
                "          {$$Reg_Number} as string,",
                "          {$$Reg_Type} as string,",
                "          {$$Reg_hall} as string,",
                "          {$$Region} as string,",
                "          {$$SHOW_NAME} as string,",
                "          {$$Source} as string,",
                "          {$$Stand_Number} as string,",
                "          {$$State} as string,",
                "          Date as string,",
                "          Filename as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     inferDriftedColumnTypes: true,",
                "     ignoreNoFilesFound: true) ~> source1",
                "source(output(",
                "          {File Name} as string,",
                "          {Event Name New} as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     ignoreNoFilesFound: false,",
                "     format: 'excel',",
                "     fileSystem: 'em-data',",
                "     folderPath: 'Input Files',",
                "     fileName: 'Filenames with Events.xlsx',",
                "     sheetIndex: 0,",
                "     firstRowAsHeader: true) ~> source3",
                "join1 select(mapColumn(",
                "          Index,",
                "          Year,",
                "          QID,",
                "          Question = Questions,",
                "          Answers,",
                "          UAID,",
                "          Type,",
                "          Filename,",
                "          EventName = {Event Name New},",
                "          each(match(startsWith(name,'$$')),",
                "               right($$,length($$)-2) = $$)",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select1",
                "source1, select2 join(upper(Filename) == upper({File Name}),",
                "     joinType:'left',",
                "     matchType:'exact',",
                "     ignoreSpaces: false,",
                "     broadcast: 'auto')~> join1",
                "source3 select(mapColumn(",
                "          {File Name},",
                "          {Event Name New}",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select2",
                "select1 derive(Reg_Date = iif (right(Reg_Date, 2)=='PM',toTimestamp(replace(replace(Reg_Date,'PM',''),'AM',''), 'dd/MM/yyyy HH:mm:ss')+hours(12), iif( instr(toString(Reg_Date),'Z') == 0,toTimestamp(replace(replace(Reg_Date,'PM',''),'AM',''), 'dd/MM/yyyy HH:mm:ss'),\r",
                "toTimestamp(left(replace(Reg_Date,'T',' '),length(Reg_Date)-1), 'yyyy-MM-dd HH:mm:ss'))),",
                "          EventName = iif (EventName=='Show Name inside the file' ,Source,EventName),",
                "          Execution_Date = currentUTC()) ~> derivedColumn1",
                "derivedColumn1 derive(EventName = iifNull(EventName, Source)) ~> derivedColumn2",
                "derivedColumn2 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          Index as string,",
                "          EventName as string,",
                "          Year as string,",
                "          Filename as string,",
                "          QID as string,",
                "          Question as string,",
                "          Answers as string,",
                "          UAID as string,",
                "          Type as string,",
                "          Execution_Date as timestamp,",
                "          {2PM_Attendance} as string,",
                "          Address_line_1 as string,",
                "          Address_line_2 as string,",
                "          Address_line_3 as string,",
                "          AGE as string,",
                "          Attended as string,",
                "          Badge_Type as string,",
                "          {Bill_to-Address_line_1} as string,",
                "          {Bill_to-Address_line_2} as string,",
                "          {Bill_to-Address_line_3} as string,",
                "          {Bill_to-City_of_Company} as string,",
                "          {Bill_to-Company_Name} as string,",
                "          {Bill_to-Country} as string,",
                "          {Bill_to-Designation} as string,",
                "          {Bill_to-First_Name} as string,",
                "          {Bill_to-Last_Name} as string,",
                "          {Bill_to-P.O._Box} as string,",
                "          {Bill_to-Postal_Code} as string,",
                "          {Bill_to-State} as string,",
                "          Campaign as string,",
                "          Campaign_Source as string,",
                "          City_of_Company as string,",
                "          Cluster_Name as string,",
                "          Company_Facebook as string,",
                "          Company_Instagram as string,",
                "          Company_Linkedin as string,",
                "          Company_Name as string,",
                "          Company_Snapchat as string,",
                "          Company_Twitter as string,",
                "          Company_Website as string,",
                "          Company_Youtube as string,",
                "          CONFERENCE_PACKAGE_FIRST_BOOKING as string,",
                "          CONFERENCE_PACKAGE_SECOND_BOOKING as string,",
                "          Conference_Package_Third_Booking as string,",
                "          Country as string,",
                "          Cross_Over_Gates as string,",
                "          Cross_Over_Overall_Day as string,",
                "          Daily_Attendance as string,",
                "          Data_Source as string,",
                "          Day_Selection as string,",
                "          Department as string,",
                "          Department_Other as string,",
                "          Designation as string,",
                "          Designation_Level as string,",
                "          Designation_Level_Other as string,",
                "          DTCM_BASKETS as string,",
                "          DWTC_Booking_Platform as string,",
                "          DWTC_CRM_ID as string,",
                "          Email as string,",
                "          Email_1 as string,",
                "          Emirates_ID_Passport_No as string,",
                "          Event_ID as string,",
                "          Event_Year as string,",
                "          Exhibition_Halls as string,",
                "          Exhibition_Packages as string,",
                "          Exhibitor_Promo_Codes as string,",
                "          Exhibitor_Type as string,",
                "          Exhibitor_Account_ID as string,",
                "          Exhibitor_Name as string,",
                "          Facial_Recognition as string,",
                "          Fax_Number as string,",
                "          First_Booking_Paid_Packages as string,",
                "          First_Name as string,",
                "          Full_Name as string,",
                "          GATE_SCANNERS as string,",
                "          Gates as string,",
                "          Gender as string,",
                "          Generic_Package_Code_Exhibition_Conference as string,",
                "          ID_Verification as string,",
                "          Personal_Data_Consent as string,",
                "          Particulars_Given_Gov as string,",
                "          Job_Function as string,",
                "          LANGUAGE_COMM as string,",
                "          Last_Name as string,",
                "          Majlis_Management as string,",
                "          Majlis_Nominating_Company as string,",
                "          Media_Geographical_Distribution as string,",
                "          MEDIA_LANGUAGE as string,",
                "          MEDIA_NAME as string,",
                "          MEDIA_TYPE as string,",
                "          MEDIA_TYPE_Other as string,",
                "          Medium as string,",
                "          Middle_Name as string,",
                "          Mobile_Number as string,",
                "          Mobile_Number_1 as string,",
                "          Nationality as string,",
                "          Onsite_Stations as string,",
                "          {P.O_Box} as string,",
                "          Pass_Selection as string,",
                "          Pavilion as string,",
                "          PAY_Currency as string,",
                "          PAY_Mode as string,",
                "          PAY_Mode_Pack_2 as string,",
                "          PAY_Mode_Pack_3 as string,",
                "          PAY_Type as string,",
                "          Payment_Channel as string,",
                "          PAYMENT_CHOICE as string,",
                "          PAYMENT_CHOICE_PACK_2 as string,",
                "          PAYMENT_CHOICE_PACK_3 as string,",
                "          PAYMENT_DETAILS as string,",
                "          PAYMENT_DETAILS_PACK_2 as string,",
                "          PAYMENT_DETAILS_PACK_3 as string,",
                "          PAYMENT_STATUS as string,",
                "          PAYMENT_STATUS_PACK_1 as string,",
                "          PAYMENT_STATUS_PACK_2 as string,",
                "          PAYMENT_STATUS_PACK_3 as string,",
                "          Personal_Facebook as string,",
                "          Personal_Instagram as string,",
                "          Personal_LinkedIn as string,",
                "          Personal_Pinterest as string,",
                "          Personal_Snapchat as string,",
                "          Personal_Twitter as string,",
                "          Personal_YouTube as string,",
                "          Phone_Extn as string,",
                "          Phone_Number as string,",
                "          Phone_Number_1 as string,",
                "          Postal_Code as string,",
                "          Pre_POP_Codes as string,",
                "          Prefix as string,",
                "          Promo_Code as string,",
                "          Promo_Code_Discount_Ticketing_Price as string,",
                "          PS_Data as string,",
                "          PUBL_FREQ as string,",
                "          PUBL_FREQ_Other as string,",
                "          Publication as string,",
                "          Receipt_No as string,",
                "          Reg_Date as timestamp,",
                "          Reg_hall as string,",
                "          Reg_hall_Other as string,",
                "          Reg_Number as string,",
                "          Reg_Type as string,",
                "          Reg_Type_Other as string,",
                "          Region as string,",
                "          Second_Booking_Paid_Packages as string,",
                "          Self_Reg_Area as string,",
                "          Sessions_Attendance as string,",
                "          SHOW_NAME as string,",
                "          Source as string,",
                "          Stand_Number as string,",
                "          State as string,",
                "          Student_ID as string,",
                "          Terms_Conditions as string,",
                "          Ticket_Selection as string,",
                "          Type_of_Data as string,",
                "          UAE_Resedency_Emirate as string,",
                "          Upgrade as string,",
                "          UTM_Values as string,",
                "          Verticals_Session as string,",
                "          VISITOR_TYPE as string,",
                "          VISITOR_TYPE_Other as string,",
                "          modifiedon as timestamp",
                "     ),",
                "     deletable:false,",
                "     insertable:true,",
                "     updateable:false,",
                "     upsertable:false,",
                "     format: 'table',",
                "     staged: true,",
                "     allowCopyCommand: true,",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError') ~> sink1"
            ]
        }
    }
}