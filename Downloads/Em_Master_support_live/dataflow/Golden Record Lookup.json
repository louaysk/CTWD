{
    "name": "Golden Record Lookup",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "DIM_COMPANY",
                        "type": "DatasetReference"
                    },
                    "name": "source2"
                },
                {
                    "dataset": {
                        "referenceName": "Dim_COUNTRY",
                        "type": "DatasetReference"
                    },
                    "name": "source3"
                },
                {
                    "dataset": {
                        "referenceName": "GoldenRecord",
                        "type": "DatasetReference"
                    },
                    "name": "source4"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "GoldenRecordFinal",
                        "type": "DatasetReference"
                    },
                    "name": "sink1"
                }
            ],
            "transformations": [
                {
                    "name": "select1"
                },
                {
                    "name": "lookup1"
                },
                {
                    "name": "select2"
                },
                {
                    "name": "lookup2"
                },
                {
                    "name": "select3"
                },
                {
                    "name": "select4"
                },
                {
                    "name": "derivedColumn1"
                },
                {
                    "name": "alterRow1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          Company_ID as integer,",
                "          Company_Name as string,",
                "          Country as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: 'SELECT [Company_ID]\\n,[Company_Name]\\n,[Country]\\n FROM [EM_DWH].[DIM_COMPANY]',",
                "     format: 'query',",
                "     staged: true) ~> source2",
                "source(output(",
                "          Country_ID as integer,",
                "          Country as string,",
                "          Country_Question_DomainID as string,",
                "          Country_AnswerDomainID as string,",
                "          {UAID-Country} as string,",
                "          Country_Code as string,",
                "          DWTC_region as string,",
                "          {UAID-Region} as string,",
                "          RegionDomainID as string,",
                "          {UAID-Nationality} as string,",
                "          NationalityDomainID as string,",
                "          NationalityNew as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     format: 'table',",
                "     staged: true) ~> source3",
                "source(output(",
                "          email as string,",
                "          grid as string,",
                "          soundex_name as string,",
                "          max_modified_date as timestamp,",
                "          Birth_Certif as timestamp,",
                "          has_crm_contact as integer,",
                "          DateCreated as timestamp,",
                "          Contact_Created_Source as string,",
                "          FirstName as string,",
                "          LastName as string,",
                "          FullName as string,",
                "          Company as string,",
                "          addressline1 as string,",
                "          Addressline2 as string,",
                "          Nationality as string,",
                "          ZIP_Postal_Code as string,",
                "          Region as string,",
                "          City as string,",
                "          Prefix as string,",
                "          JobFunction as long,",
                "          ContactType as string,",
                "          Modifiedby as string,",
                "          Createdby as string,",
                "          State as string,",
                "          Statuscode as string,",
                "          Globally_Unsubscribed as string,",
                "          Email_HardBounce as string,",
                "          Country as string,",
                "          MobilePhone as string,",
                "          jobtitle as string,",
                "          SeniorityLevel as string,",
                "          MobilePhone2 as string,",
                "          PhoneNumber1 as string,",
                "          PhoneNumber2 as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: 'SELECT  [email],\\nCONVERT(NVARCHAR(16),hashbytes(\\'md5\\',concat(upper(replace(email,\\' \\',\\'\\')),soundex_name)),2) grid\\n,[soundex_name]\\n,[max_modified_date]\\n,[Birth_Certif]\\n,[has_crm_contact]\\n,[DateCreated]\\n,[Contact_Created_Source]\\n,[FirstName]\\n,[LastName]\\n,[FullName]\\n,[Company]\\n,[addressline1]\\n,[Addressline2]\\n,[Nationality]\\n,[ZIP_Postal_Code]\\n,[Region]\\n,[City]\\n,[Prefix]\\n,[JobFunction]\\n,[ContactType]\\n,[Modifiedby]\\n,[Createdby]\\n,[State]\\n,[Statuscode]\\n,[Globally_Unsubscribed]\\n,[Email_HardBounce]\\n,[Country]\\n,[MobilePhone]\\n,[jobtitle]\\n,[SeniorityLevel]\\n,[MobilePhone2]\\n,[PhoneNumber1]\\n,[PhoneNumber2]\\n FROM [EM_DWH].[GOLDENRECORD]',",
                "     format: 'query',",
                "     staged: true) ~> source4",
                "source4 select(mapColumn(",
                "          email,",
                "          grid,",
                "          soundex_name,",
                "          max_modified_date,",
                "          Birth_Certif,",
                "          has_crm_contact,",
                "          DateCreated,",
                "          Contact_Created_Source,",
                "          FirstName,",
                "          LastName,",
                "          FullName,",
                "          Company,",
                "          addressline1,",
                "          Addressline2,",
                "          Nationality,",
                "          ZIP_Postal_Code,",
                "          Region,",
                "          City,",
                "          Prefix,",
                "          JobFunction,",
                "          ContactType,",
                "          Modifiedby,",
                "          Createdby,",
                "          State,",
                "          Statuscode,",
                "          Globally_Unsubscribed,",
                "          Email_HardBounce,",
                "          Country,",
                "          MobilePhone,",
                "          jobtitle,",
                "          SeniorityLevel,",
                "          MobilePhone2,",
                "          PhoneNumber1,",
                "          PhoneNumber2",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select1",
                "select1, source2 lookup(upper(select1@Country) == upper(source2@Country)",
                "     && upper(Company) == upper(Company_Name),",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup1",
                "lookup1 select(mapColumn(",
                "          email,",
                "          grid,",
                "          soundex_name,",
                "          max_modified_date,",
                "          Birth_Certif,",
                "          has_crm_contact,",
                "          DateCreated,",
                "          Contact_Created_Source,",
                "          FirstName,",
                "          LastName,",
                "          FullName,",
                "          Company,",
                "          addressline1,",
                "          Addressline2,",
                "          Nationality,",
                "          ZIP_Postal_Code,",
                "          Region,",
                "          City,",
                "          Prefix,",
                "          JobFunction,",
                "          ContactType,",
                "          Modifiedby,",
                "          Createdby,",
                "          State,",
                "          Statuscode,",
                "          Globally_Unsubscribed,",
                "          Email_HardBounce,",
                "          Country = select1@Country,",
                "          Company_ID,",
                "          MobilePhone,",
                "          jobtitle,",
                "          SeniorityLevel,",
                "          MobilePhone2,",
                "          PhoneNumber1,",
                "          PhoneNumber2",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select2",
                "select2, select3 lookup(upper(select2@Country) == upper(select3@Country),",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup2",
                "source3 select(mapColumn(",
                "          Country_ID,",
                "          Country",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select3",
                "lookup2 select(mapColumn(",
                "          email,",
                "          grid,",
                "          soundex_name,",
                "          max_modified_date,",
                "          Birth_Certif,",
                "          has_crm_contact,",
                "          DateCreated,",
                "          Contact_Created_Source,",
                "          FirstName,",
                "          LastName,",
                "          FullName,",
                "          Company,",
                "          addressline1,",
                "          Addressline2,",
                "          Nationality,",
                "          ZIP_Postal_Code,",
                "          Region,",
                "          City,",
                "          Prefix,",
                "          JobFunction,",
                "          ContactType,",
                "          Modifiedby,",
                "          Createdby,",
                "          State,",
                "          Statuscode,",
                "          Globally_Unsubscribed,",
                "          Email_HardBounce,",
                "          Country = select2@Country,",
                "          Company_ID,",
                "          Country_ID,",
                "          MobilePhone,",
                "          jobtitle,",
                "          SeniorityLevel,",
                "          MobilePhone2,",
                "          PhoneNumber1,",
                "          PhoneNumber2",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select4",
                "select4 derive(executiondate = currentUTC(),",
                "          JobFunction = toString(JobFunction)) ~> derivedColumn1",
                "derivedColumn1 alterRow(upsertIf(1==1)) ~> alterRow1",
                "alterRow1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          Contact_GR_ID as integer,",
                "          soundex_name as string,",
                "          max_modified_date as timestamp,",
                "          Email as string,",
                "          has_crm_contact as string,",
                "          Birth_Certif as timestamp,",
                "          MobilePhone as string,",
                "          Country as string,",
                "          CountryID as integer,",
                "          DateCreated as timestamp,",
                "          Contact_Created_Source as string,",
                "          jobtitle as string,",
                "          firstname as string,",
                "          lastname as string,",
                "          fullname as string,",
                "          ContactType as string,",
                "          Company as string,",
                "          CompanyID as integer,",
                "          Address_line_1 as string,",
                "          Address_line_2 as string,",
                "          Nationality as string,",
                "          City as string,",
                "          Prefix as string,",
                "          Region as string,",
                "          ZIP_Postal_Code as string,",
                "          State as string,",
                "          Createdby as string,",
                "          Modifiedby as string,",
                "          JobFunction as string,",
                "          Statuscode as string,",
                "          Globally_Unsubscribed as string,",
                "          Email1_HardBounce as string,",
                "          grid as string,",
                "          ExecutionDate as timestamp,",
                "          SeniorityLevel as string,",
                "          PhoneNumber2 as string,",
                "          PhoneNumber1 as string,",
                "          MobilePhone2 as string",
                "     ),",
                "     deletable:false,",
                "     insertable:true,",
                "     updateable:false,",
                "     upsertable:true,",
                "     keys:['grid'],",
                "     format: 'table',",
                "     staged: true,",
                "     allowCopyCommand: true,",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError',",
                "     mapColumn(",
                "          grid,",
                "          max_modified_date,",
                "          Email = email,",
                "          has_crm_contact,",
                "          firstname = FirstName,",
                "          lastname = LastName,",
                "          jobtitle,",
                "          Birth_Certif,",
                "          State,",
                "          DateCreated,",
                "          Contact_Created_Source,",
                "          MobilePhone,",
                "          ContactType,",
                "          Company,",
                "          CompanyID = Company_ID,",
                "          CountryID = Country_ID,",
                "          Nationality,",
                "          Address_line_1 = addressline1,",
                "          Address_line_2 = Addressline2,",
                "          City,",
                "          ZIP_Postal_Code,",
                "          Country,",
                "          Statuscode,",
                "          Globally_Unsubscribed,",
                "          Email1_HardBounce = Email_HardBounce,",
                "          Createdby,",
                "          Region,",
                "          Modifiedby,",
                "          Prefix,",
                "          JobFunction,",
                "          ExecutionDate = executiondate,",
                "          soundex_name,",
                "          SeniorityLevel,",
                "          MobilePhone2,",
                "          PhoneNumber1,",
                "          PhoneNumber2",
                "     ),",
                "     partitionBy('hash', 4,",
                "          grid",
                "     )) ~> sink1"
            ]
        }
    }
}