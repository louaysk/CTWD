{
    "name": "DF_Load_Dim_Contact_ELQ",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "ods_contactelq",
                        "type": "DatasetReference"
                    },
                    "name": "source1"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "DIM_CONTACT_ELQ",
                        "type": "DatasetReference"
                    },
                    "name": "sink1"
                }
            ],
            "transformations": [
                {
                    "name": "select1"
                },
                {
                    "name": "alterRow1"
                },
                {
                    "name": "filter1"
                },
                {
                    "name": "derivedColumn1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          C_Address1 as string,",
                "          C_Address2 as string,",
                "          C_Address3 as string,",
                "          C_Age_Group1 as string,",
                "          C_BusPhone as string,",
                "          C_City as string,",
                "          C_Company as string,",
                "          C_Company_Revenue1 as string,",
                "          C_Company_Size1 as string,",
                "          C_Company_Website1 as string,",
                "          C_Country as string,",
                "          C_DateCreated as string,",
                "          C_DateModified as string,",
                "          C_Designation1 as string,",
                "          C_ElqPURLName as string,",
                "          C_FirstAndLastName as string,",
                "          C_FirstName as string,",
                "          C_Gender1 as string,",
                "          C_IND_ID11 as string,",
                "          C_Industry1 as string,",
                "          C_Job_Function1 as string,",
                "          C_Job_Role1 as string,",
                "          C_LastName as string,",
                "          C_MSCRMAccountID as string,",
                "          C_MSCRMContactID as string,",
                "          C_MSCRMLastCampaignID as string,",
                "          C_MSCRMLastCampaignName as string,",
                "          C_MSCRMLastCampaignStatus as string,",
                "          C_MSCRMLeadID as string,",
                "          C_MSCRM_LeadRating as string,",
                "          C_Middle_Name1 as string,",
                "          C_MobilePhone as string,",
                "          C_Nationality1 as string,",
                "          C_Pavilion1 as string,",
                "          C_Region1 as string,",
                "          C_SFDCAccountID as string,",
                "          C_SFDCContactID as string,",
                "          C_SFDCLastCampaignID as string,",
                "          C_SFDCLastCampaignStatus as string,",
                "          C_SFDCLeadID as string,",
                "          C_Salesperson as string,",
                "          C_Salutation as string,",
                "          C_State_Prov as string,",
                "          C_Territory as string,",
                "          C_Title as string,",
                "          C_Username1 as string,",
                "          C_Zip_Postal as string,",
                "          C_elqPURLName1 as string,",
                "          ContactIDExt as string,",
                "          Contact_Id as string,",
                "          EmailAddress as string,",
                "          EmailFormat as string,",
                "          IsBounced as string,",
                "          IsSubscribed as string,",
                "          Instance as string,",
                "          C_EmailDisplayName as string,",
                "          C_Fax as string,",
                "          C_Full_Name1 as string,",
                "          C_IND_ID1 as string,",
                "          C_Annual_Revenue1 as string,",
                "          C_Date_of_Birth1 as string,",
                "          C_Designation_Level1 as string,",
                "          C_Lead_Status1 as string,",
                "          C_List_Source1 as string,",
                "          C_MSCRM_EmailOptOut as string,",
                "          C_PAHB_URL1 as string,",
                "          C_SFDC_EmailOptOut1 as string,",
                "          C_URN_Number___Infosalons1 as string,",
                "          Index as integer,",
                "          Date_Execution as string,",
                "          grid as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: 'SELECT *,\\n     CONVERT(NVARCHAR(16), hashbytes(\\'md5\\', \\n        concat(\\n            upper(replace([emailaddress],\\' \\',\\'\\')),\\n            COALESCE(soundex(NULLIF(replace([C_FirstName] ,\\' \\',\\'\\') , \\'\\')),\\'NA\\'),\\n            COALESCE(soundex(NULLIF(replace([C_LastName]  ,\\' \\',\\'\\') , \\'\\')),\\'NA\\'),\\n            COALESCE(soundex(NULLIF(replace([C_Company],\\' \\',\\'\\'), \\'\\')),\\'NA\\') \\n        )\\n    ), 2) AS grid\\nFROM [ods].[Em_Contact] \\nWHERE CAST(Date_Execution AS datetime2) > (\\n    SELECT DISTINCT Entry_Date FROM [ods].[EM_Eloqua_Parametres] WHERE Tablename=\\'contacts\\'\\n) AND Date_Execution IS NOT NULL',",
                "     format: 'query',",
                "     staged: true) ~> source1",
                "source1 select(mapColumn(",
                "          C_Address1,",
                "          C_Age_Group1,",
                "          C_City,",
                "          C_Company,",
                "          C_Country,",
                "          C_DateCreated,",
                "          C_DateModified,",
                "          C_Designation1,",
                "          C_FirstAndLastName,",
                "          C_FirstName,",
                "          C_Job_Function1,",
                "          C_Job_Role1,",
                "          C_LastName,",
                "          C_MobilePhone,",
                "          C_Nationality1,",
                "          C_Region1,",
                "          C_Title,",
                "          ContactIDExt,",
                "          Contact_Id,",
                "          EmailAddress,",
                "          IsBounced,",
                "          IsSubscribed,",
                "          Instance,",
                "          C_SFDCContactID,",
                "          C_BusPhone,",
                "          grid",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select1",
                "derivedColumn1 alterRow(upsertIf(1==1)) ~> alterRow1",
                "select1 filter(not(isNull(EmailAddress))) ~> filter1",
                "filter1 derive(Execution_DateDWH = currentUTC()) ~> derivedColumn1",
                "alterRow1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          Contact_ID as integer,",
                "          Address as string,",
                "          Age_Group as string,",
                "          City as string,",
                "          CompanyName as string,",
                "          Country as string,",
                "          DateCreated as string,",
                "          DateModified as string,",
                "          JobTitle as string,",
                "          FullName as string,",
                "          FirstName as string,",
                "          Job_Function as string,",
                "          Job_Role as string,",
                "          LastName as string,",
                "          MobilePhone as string,",
                "          Nationality as string,",
                "          Region as string,",
                "          SFDCContactID as string,",
                "          Title as string,",
                "          ContactIDExt as string,",
                "          Contact_Code as string,",
                "          Email as string,",
                "          IsBounced as string,",
                "          IsSubscribed as string,",
                "          Instance as string,",
                "          Contact_GR_ID as integer,",
                "          Date_Execution as timestamp,",
                "          GR_ID as string,",
                "          MobilePhone2 as string",
                "     ),",
                "     deletable:false,",
                "     insertable:true,",
                "     updateable:false,",
                "     upsertable:true,",
                "     keys:['Email','Instance'],",
                "     format: 'table',",
                "     staged: true,",
                "     allowCopyCommand: true,",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError',",
                "     mapColumn(",
                "          Address = C_Address1,",
                "          Age_Group = C_Age_Group1,",
                "          City = C_City,",
                "          CompanyName = C_Company,",
                "          Country = C_Country,",
                "          DateCreated = C_DateCreated,",
                "          DateModified = C_DateModified,",
                "          JobTitle = C_Designation1,",
                "          FullName = C_FirstAndLastName,",
                "          FirstName = C_FirstName,",
                "          Job_Function = C_Job_Function1,",
                "          Job_Role = C_Job_Role1,",
                "          LastName = C_LastName,",
                "          MobilePhone = C_MobilePhone,",
                "          Nationality = C_Nationality1,",
                "          Region = C_Region1,",
                "          SFDCContactID = C_SFDCContactID,",
                "          Title = C_Title,",
                "          ContactIDExt,",
                "          Contact_Code = Contact_Id,",
                "          Email = EmailAddress,",
                "          IsBounced,",
                "          IsSubscribed,",
                "          Instance,",
                "          Date_Execution = Execution_DateDWH,",
                "          MobilePhone2 = C_BusPhone,",
                "          GR_ID = grid",
                "     )) ~> sink1"
            ]
        }
    }
}